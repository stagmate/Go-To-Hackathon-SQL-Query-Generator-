<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gojek AI SQL Query Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library (for copy and sparkle icon) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.2/phosphor-icons.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
        /* Hide number input arrows */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Simple loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen antialiased">

    <div class="w-full bg-white shadow-md">
        <div class="container mx-auto max-w-5xl px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">
                <span class="text-green-600">Gojek</span> AI SQL Query Generator
            </h1>
            <p class="text-gray-600">Ask a question, and the AI will generate the correct query.</p>
        </div>
    </div>

    <div class="container mx-auto max-w-5xl px-4 py-8">
        
        <!-- 1. Search Input -->
        <div class="mb-6">
            <label for="search-query" class="block text-sm font-medium text-gray-700 mb-2">Ask your question</label>
            <div class="flex items-center gap-2">
                <input type="text" id="search-query" 
                       placeholder="e.g., 'average orders for GoRide in Jakarta last week'"
                       class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-lg">
                <button id="generate-sql-btn" class="bg-green-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center gap-2">
                    <i class="ph-sparkle text-xl"></i>
                    <span id="generate-btn-text">Generate</span>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </button>
            </div>
        </div>

        <!-- Error/Status Message Area -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">Error: </strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- 4. SQL Output (hidden by default) -->
        <div id="sql-output-section" class="bg-gray-900 p-6 rounded-lg shadow-md relative hidden">
            <h2 class="text-xl font-bold text-white mb-4">Generated SQL Query</h2>
            <button id="copy-sql-btn" title="Copy to Clipboard" class="absolute top-4 right-4 bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white p-2 rounded-lg transition duration-200">
                <i class="ph-clipboard-text text-xl"></i>
            </button>
            <pre><code id="sql-output" class="text-green-300 whitespace-pre-wrap break-all">...</code></pre>
            <div id="copy-success" class="absolute top-14 right-4 bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded shadow-md hidden">
                Copied!
            </div>
        </div>
    </div>

    <script>
        // --- THE METRIC REGISTRY ---
        // This is your "database" of hard-coded metrics.
        // The AI will use this as context, but the app will use it to build the final query.
        const METRIC_REGISTRY = [
            {
                id: 'avg_daily_orders',
                name: 'Average Daily Orders',
                description: 'The average number of completed orders per day.',
                keywords: ['orders', 'average', 'daily', 'per day', 'avg', 'count'],
                // Parameters this template accepts
                parameters: ['dateRange', 'product', 'region'],
                // sqlTemplate is a function that receives params and returns a string
                sqlTemplate: (params) => {
                    // Use defaults if AI doesn't provide a value
                    const { startDate, endDate } = getDates(params.startDate, params.endDate);
                    const product = params.product || 'All';
                    const region = params.region || 'All';
                    
                    return `
-- METRIC: Average Daily Orders
-- DESCRIPTION: ${METRIC_REGISTRY.find(m => m.id === 'avg_daily_orders').description}
-- DATE RANGE: ${startDate} to ${endDate}
-- PRODUCT: ${product}
-- REGION: ${region}

WITH daily_orders AS (
    SELECT
        TO_DATE(order_timestamp) AS order_date,
        COUNT(DISTINCT order_id) AS daily_order_count
    FROM
        p_gojek_prod.final.orders_mart
    WHERE
        order_status = 'COMPLETED'
        AND TO_DATE(order_timestamp) BETWEEN '${startDate}' AND '${endDate}'
        ${product !== 'All' ? `AND product_type = '${product}'` : '-- All Products'}
        ${region !== 'All' ? `AND city_name = '${region}'` : '-- All Regions'}
    GROUP BY
        1
)
SELECT
    AVG(daily_order_count) AS average_daily_orders
FROM
    daily_orders;
                `;}
            },
            {
                id: 'total_gtv',
                name: 'Total Earnings (GTV)',
                description: 'The sum of Gross Transaction Value (GTV) in local currency.',
                keywords: ['earnings', 'total', 'gtv', 'revenue', 'money', 'sum'],
                parameters: ['dateRange', 'region'],
                sqlTemplate: (params) => {
                    const { startDate, endDate } = getDates(params.startDate, params.endDate);
                    const region = params.region || 'All';

                    return `
-- METRIC: Total Earnings (GTV)
-- DESCRIPTION: ${METRIC_REGISTRY.find(m => m.id === 'total_gtv').description}
-- DATE RANGE: ${startDate} to ${endDate}
-- REGION: ${region}

SELECT
    SUM(gtv_amount_local) AS total_gtv,
    'IDR' AS currency -- (Assuming local currency)
FROM
    p_gojek_prod.final.earnings_fact
WHERE
    TO_DATE(booking_timestamp) BETWEEN '${startDate}' AND '${endDate}'
    ${region !== 'All' ? `AND city_name = '${region}'` : '-- All Regions'};
                `;}
            },
            {
                id: 'daily_active_drivers',
                name: 'Daily Active Drivers (Avg)',
                description: 'The average number of unique drivers active per day.',
                keywords: ['drivers', 'active', 'daily', 'avg', 'unique', 'partners'],
                parameters: ['dateRange', 'product'],
                sqlTemplate: (params) => {
                    const { startDate, endDate } = getDates(params.startDate, params.endDate);
                    const product = params.product || 'All';
                    
                    return `
-- METRIC: Daily Active Drivers (Avg)
-- DESCRIPTION: ${METRIC_REGISTRY.find(m => m.id === 'daily_active_drivers').description}
-- DATE RANGE: ${startDate} to ${endDate}
-- PRODUCT: ${product}

WITH daily_drivers AS (
    SELECT
        TO_DATE(event_timestamp) AS activity_date,
        COUNT(DISTINCT driver_id) AS unique_drivers
    FROM
        p_gojek_prod.raw.driver_ping_logs -- (Invented table for illustration)
    WHERE
        TO_DATE(event_timestamp) BETWEEN '${startDate}' AND '${endDate}'
        ${product !== 'All' ? `AND active_product = '${product}'` : '-- All Products'}
    GROUP BY
        1
)
SELECT
    AVG(unique_drivers) AS average_daily_active_drivers
FROM
    daily_drivers;
                `;}
            },
            {
                id: 'caretech_ratings',
                name: 'Average CareTech Rating',
                description: 'Average rating given for CareTech services.',
                keywords: ['rating', 'caretech', 'avg', 'average', 'feedback'],
                parameters: ['dateRange'],
                sqlTemplate: (params) => {
                    const { startDate, endDate } = getDates(params.startDate, params.endDate);

                    return `
-- METRIC: Average CareTech Rating
-- DESCRIPTION: ${METRIC_REGISTRY.find(m => m.id === 'caretech_ratings').description}
-- DATE RANGE: ${startDate} to ${endDate}

SELECT
    AVG(rating_stars) AS average_caretech_rating
FROM
    p_gojek_id_raw.extstream.clickstream_component_log
WHERE
    product = 'CareTech'
    AND event_name = 'Driver Rating Star Click'
    AND TO_DATE(event_timestamp) BETWEEN '${startDate}' AND '${endDate}'
    AND rating_stars IS NOT NULL;
                `;}
            }
        ];

        // --- DOM Elements ---
        const searchQueryInput = document.getElementById('search-query');
        const generateSqlBtn = document.getElementById('generate-sql-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        const errorMessageEl = document.getElementById('error-message');
        const errorTextEl = document.getElementById('error-text');

        const sqlOutputSection = document.getElementById('sql-output-section');
        const sqlOutputEl = document.getElementById('sql-output');
        const copySqlBtn = document.getElementById('copy-sql-btn');
        const copySuccessEl = document.getElementById('copy-success');

        // --- Helper Functions ---

        /**
         * Sets the loading state for the generate button.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                generateBtnText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                generateSqlBtn.disabled = true;
                searchQueryInput.disabled = true;
            } else {
                generateBtnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                generateSqlBtn.disabled = false;
                searchQueryInput.disabled = false;
            }
        }

        /**
         * Shows an error message.
         */
        function showError(message) {
            errorTextEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
        }

        /**
         * Hides the error message.
         */
        function hideError() {
            errorMessageEl.classList.add('hidden');
        }

        /**
         * Returns default start/end dates if not provided.
         * Formats: YYYY-MM-DD
         */
        function getDates(startDate, endDate) {
            // Check for the specific "NOT_SPECIFIED" string from the AI
            if (startDate === 'NOT_SPECIFIED' || !startDate || endDate === 'NOT_SPECIFIED' || !endDate) {
                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - 7); // Default to last 7 days
                
                return {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                };
            }
            return {
                start: startDate,
                end: endDate
            };
        }

        /**
         * Copies text to the clipboard.
         */
        function copyToClipboard(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                copySuccessEl.classList.remove('hidden');
                setTimeout(() => {
                    copySuccessEl.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                showError('Failed to copy to clipboard.');
            }
        }

        // --- AI & Generation Logic ---

        /**
         * Creates the system prompt for the AI.
         * This simplifies the registry to only what the AI needs to know.
         */
        function createSystemPrompt() {
            const today = new Date().toISOString().split('T')[0];
            const contextMetrics = METRIC_REGISTRY.map(m => ({
                id: m.id,
                name: m.name,
                description: m.description,
                keywords: m.keywords
            }));

            return `You are a Gojek SQL Query Bot. Your task is to analyze a user's natural language question and map it to a pre-defined metric from a registry. You MUST return a JSON object that identifies the correct metric and extracts the required parameters.

**Metric Registry (Context):**
${JSON.stringify(contextMetrics, null, 2)}

**Instructions:**
1.  Read the user's query.
2.  Compare the query to the \`name\`, \`description\`, and \`keywords\` in the Metric Registry.
3.  Select the *single best* matching \`id\`. If no metric is a good match, return 'none' for the metricId.
4.  Extract the following parameters from the user's query:
    * \`startDate\` & \`endDate\`: Infer from relative terms ('last week', 'today', 'past 30 days'). Today is ${today}. If no date is mentioned, return 'NOT_SPECIFIED' for both.
    * \`product\`: (e.g., 'GoRide', 'GoCar', 'CareTech'). If not mentioned or is "all", return 'All'.
    * \`region\`: (e.g., 'Jakarta', 'Bandung'). If not mentioned or is "all", return 'All'.
5.  You MUST return a JSON object matching the specified schema.
`;
        }
        
        /**
         * Defines the JSON schema we expect from the AI.
         */
        const AI_RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                metricId: { 
                    type: "STRING",
                    description: "The 'id' of the single best matching metric from the registry. Use 'none' if no match."
                },
                startDate: { 
                    type: "STRING", 
                    description: "The start date in YYYY-MM-DD format. Infer from user's query. Use 'NOT_SPECIFIED' if not found." 
                },
                endDate: { 
                    type: "STRING",
                    description: "The end date in YYYY-MM-DD format. Infer from user's query. Use 'NOT_SPECIFIED' if not found."
                },
                product: { 
                    type: "STRING",
                    description: "The product (e.g., 'GoRide', 'GoCar'). Use 'All' if not specified."
                },
                region: {
                    type: "STRING",
                    description: "The region or city (e.g., 'Jakarta'). Use 'All' if not specified."
                }
            },
            required: ["metricId", "startDate", "endDate", "product", "region"]
        };


        /**
         * Calls the Gemini API to interpret the user's query.
         */
        async function getAiInterpretation(userQuery, systemPrompt) {
            const apiKey = ""; // Leave empty, will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [
                    { parts: [{ text: userQuery }] }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: AI_RESPONSE_SCHEMA
                }
            };
            
            // --- Retry logic ---
            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            // Successfully parsed JSON text
                            return JSON.parse(candidate.content.parts[0].text);
                        } else {
                            // Handle non-blocking errors (e.g., no content)
                            throw new Error('AI response was empty or malformed.');
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // Other client-side error (e.g., 400), don't retry
                        const errorResult = await response.json();
                        throw new Error(`API Error: ${errorResult.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        // Last retry failed
                        throw error; // Re-throw the last error
                    }
                }
            }
        }


        /**
         * Main handler for the "Generate SQL" button click.
         */
        async function handleGenerateSql() {
            hideError();
            const userQuery = searchQueryInput.value;
            if (!userQuery.trim()) {
                showError('Please ask a question.');
                return;
            }

            setLoading(true);
            sqlOutputSection.classList.add('hidden');

            try {
                const systemPrompt = createSystemPrompt();
                const aiResponse = await getAiInterpretation(userQuery, systemPrompt);

                if (!aiResponse || aiResponse.metricId === 'none') {
                    showError("Sorry, I couldn't find a matching metric for your question. Please try rephrasing.");
                    setLoading(false);
                    return;
                }
                
                // Find the metric in our *local* registry
                const metric = METRIC_REGISTRY.find(m => m.id === aiResponse.metricId);
                
                if (!metric) {
                    showError(`AI returned an invalid metric ID: ${aiResponse.metricId}.`);
                    setLoading(false);
                    return;
                }

                // AI provides the parameters, our template builds the SQL
                const sqlQuery = metric.sqlTemplate(aiResponse);
                
                // Trim and display
                sqlOutputEl.textContent = sqlQuery.trim();
                sqlOutputSection.classList.remove('hidden');
                
                // Scroll to the output
                sqlOutputSection.scrollIntoView({ behavior: 'smooth', block: 'end' });

            } catch (error) {
                console.error('Error during AI generation:', error);
                showError(`Generation failed: ${error.message}. Please check console.`);
            } finally {
                setLoading(false);
            }
        }
        
        // --- Attach Event Listeners ---
        generateSqlBtn.addEventListener('click', handleGenerateSql);
        copySqlBtn.addEventListener('click', () => {
            copyToClipboard(sqlOutputEl.textContent);
        });
        // Allow pressing Enter to generate
        searchQueryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                handleGenerateSql();
            }
        });

    </script>

</body>
</html>
